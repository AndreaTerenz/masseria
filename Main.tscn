[gd_scene load_steps=7 format=3 uid="uid://y03djfecm8p4"]

[ext_resource type="Texture2D" uid="uid://dltdiujt2av7s" path="res://Assets/kenney_shape-characters/PNG/Default/tile_grey.png" id="2_5qmts"]
[ext_resource type="PackedScene" uid="uid://tw01u1ja1wh7" path="res://KitchenThings/oven.tscn" id="3_6da2g"]
[ext_resource type="Texture2D" uid="uid://c8fnt88ij35hb" path="res://Assets/kenney_shape-characters/PNG/Default/yellow_body_square.png" id="3_piqc7"]
[ext_resource type="Texture2D" uid="uid://droy782oinaw" path="res://icon.svg" id="4_bfiv8"]

[sub_resource type="GDScript" id="GDScript_i6dm0"]
resource_name = "kitchen"
script/source = "extends Node2D

var agent_scene = preload(\"res://dummy_agent.tscn\")

var jobs := []
var orders := 0:
	set(v):
		orders = v
		$PizzaLabel.text = \"Total orders: \" + str(orders)
var on_cooldown = false
@onready var timer = Timer.new()

func _on_button_pressed() -> void:
	# AgentManager.send_broadcast(&\"PISELLARE\", 69)
	add_job(0, null)
	orders += 1
	

func add_job(id: int, location=null):
	jobs.append([id, location])
	print(\"Added job \", id, \" \", location)
	
func request_job(curriculum):
	var job_id = -1
	var job_location = null
	
	if on_cooldown:
		return [job_id, job_location]
	
	for job in jobs:
		if curriculum[job[0]]:
			
			var valid_job = false
			if job[0] == 0:
				for child in self.find_children(\"*\"):
					if child.is_in_group(\"Tables\") and not child.occupied:
						valid_job = true
			elif job[0] == 2:
				for child in self.find_children(\"*\"):
					if child.is_in_group(\"Ovens\") and not child.occupied:
						valid_job = true
			else:
				valid_job = true
						
			if valid_job:
				job_id = job[0]
				job_location = job[1]
				jobs.erase(job)
				on_cooldown = true
				timer.start()
				print(\"Returned job \", job)
				break
	return [job_id, job_location]
	
func _on_timer_timeout() -> void:
	on_cooldown = false

func _on_agent_button_pressed():
	var agg = agent_scene.instantiate()
	agg.path = $IdlePath
	agg.kitchen = self
	# TODO: Is this the best way?
	agg.break_location = $BreakPoint.position
	add_child(agg)
	agg.connect(\"delivered\", func reduce(): orders-=1)
	# AgentManager.register_agent(agg)

func _ready():
	for child in self.find_children(\"*\"):
		if child.is_in_group(\"Tables\"):
			child.set_script(load(\"res://Script/kitchen_sprite.gd\"))
	# TODO: This fix is extremely ass. It works.
	add_child(timer)
	timer.connect(\"timeout\", Callable(self, \"_on_timer_timeout\"))
	timer.wait_time = 0.2
"

[sub_resource type="Curve2D" id="Curve2D_obaid"]
_data = {
"points": PackedVector2Array(0, 0, 0, 0, 384, 192, 0, 0, 0, 0, 768, 192, 0, 0, 0, 0, 832, 320, 0, 0, 0, 0, 768, 448, 0, 0, 0, 0, 384, 448, 0, 0, 0, 0, 320, 320, 0, 0, 0, 0, 384, 192)
}
point_count = 7

[node name="Kitchen" type="Node2D"]
script = SubResource("GDScript_i6dm0")

[node name="IdlePath" type="Path2D" parent="."]
curve = SubResource("Curve2D_obaid")

[node name="Oven" parent="." instance=ExtResource("3_6da2g")]
position = Vector2(64, 584)

[node name="Oven2" parent="." instance=ExtResource("3_6da2g")]
position = Vector2(192, 584)

[node name="Oven3" parent="." instance=ExtResource("3_6da2g")]
position = Vector2(960, 584)

[node name="Oven4" parent="." instance=ExtResource("3_6da2g")]
position = Vector2(1088, 584)

[node name="Table" type="Sprite2D" parent="." groups=["Tables"]]
position = Vector2(512, 320)
scale = Vector2(1.6, 1.6)
texture = ExtResource("2_5qmts")

[node name="Table2" type="Sprite2D" parent="." groups=["Tables"]]
position = Vector2(640, 320)
scale = Vector2(1.6, 1.6)
texture = ExtResource("2_5qmts")

[node name="Table3" type="Sprite2D" parent="." groups=["Tables"]]
position = Vector2(512, 584)
scale = Vector2(1.6, 1.6)
texture = ExtResource("2_5qmts")

[node name="Table4" type="Sprite2D" parent="." groups=["Tables"]]
position = Vector2(640, 584)
scale = Vector2(1.6, 1.6)
texture = ExtResource("2_5qmts")

[node name="Fridge" type="Sprite2D" parent="." groups=["Fridges"]]
position = Vector2(1088, 128)
scale = Vector2(1.6, 3.2)
texture = ExtResource("2_5qmts")

[node name="DoughFridge" type="Sprite2D" parent="." groups=["Fridges"]]
position = Vector2(64, 128)
scale = Vector2(1.6, 3.2)
texture = ExtResource("2_5qmts")

[node name="Exit" type="Sprite2D" parent="." groups=["Exit"]]
position = Vector2(576, 16)
scale = Vector2(3.2, 0.4)
texture = ExtResource("3_piqc7")

[node name="Button" type="Button" parent="."]
offset_left = 8.0
offset_top = 296.0
offset_right = 153.0
offset_bottom = 343.0
pivot_offset = Vector2(0, 16)
theme_override_font_sizes/font_size = 28
text = "New pizza"

[node name="AgentButton" type="Button" parent="."]
offset_left = 8.0
offset_top = 363.0
offset_right = 153.0
offset_bottom = 410.0
pivot_offset = Vector2(0, 16)
theme_override_font_sizes/font_size = 28
text = "Add agent"

[node name="PizzaLabel" type="Label" parent="."]
offset_left = 141.0
offset_top = 8.0
offset_right = 323.0
offset_bottom = 42.0
theme_override_colors/font_color = Color(1, 1, 1, 1)
theme_override_colors/font_shadow_color = Color(0.792157, 0.176471, 0, 1)
theme_override_font_sizes/font_size = 24
text = "Total orders: 0"

[node name="BreakLabel" type="Label" parent="."]
offset_left = 956.0
offset_top = 279.0
offset_right = 1092.0
offset_bottom = 314.0
theme_override_colors/font_color = Color(1, 1, 1, 1)
theme_override_colors/font_shadow_color = Color(0, 0.501961, 1, 1)
theme_override_font_sizes/font_size = 25
text = "Break Time"

[node name="BreakPoint" type="Sprite2D" parent="." groups=["Break"]]
modulate = Color(1, 1, 1, 0.270588)
position = Vector2(1026, 385)
texture = ExtResource("4_bfiv8")

[connection signal="pressed" from="Button" to="." method="_on_button_pressed"]
[connection signal="pressed" from="AgentButton" to="." method="_on_agent_button_pressed"]
