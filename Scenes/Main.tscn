[gd_scene load_steps=17 format=3 uid="uid://y03djfecm8p4"]

[ext_resource type="PackedScene" uid="uid://tw01u1ja1wh7" path="res://Scenes/KitchenThings/oven.tscn" id="1_nda1u"]
[ext_resource type="PackedScene" uid="uid://cvquwoqa7jito" path="res://Scenes/KitchenThings/table.tscn" id="2_5wjk2"]
[ext_resource type="Texture2D" uid="uid://dltdiujt2av7s" path="res://Assets/kenney_shape-characters/PNG/Default/tile_grey.png" id="3_nlnuv"]
[ext_resource type="Texture2D" uid="uid://c8fnt88ij35hb" path="res://Assets/kenney_shape-characters/PNG/Default/yellow_body_square.png" id="4_bx3c8"]
[ext_resource type="Texture2D" uid="uid://droy782oinaw" path="res://icon.svg" id="5_kmdbf"]
[ext_resource type="Script" path="res://Script/score.gd" id="6_8jt66"]

[sub_resource type="GDScript" id="GDScript_i6dm0"]
resource_name = "kitchen"
script/source = "extends Node2D

signal orders_changed(new_val: int, diff: int)

@export var agent_scene : PackedScene = preload(\"res://Scenes/Agent.tscn\")

@onready var jobs_list: ScrollContainer = %JobsList
@onready var agents_list = %AgentsList
@onready var idle_path: Path2D = $IdlePath
@onready var break_point: Sprite2D = $BreakPoint

var timer := Timer.new()
var jobs : Array[Array] = []
var on_cooldown := false
var orders := 0:
	set(v):
		var diff : int = v - orders
		orders = v
		orders_changed.emit(orders, diff)

func _ready():
	# TODO: This fix is extremely ass. It works.
	add_child(timer)
	timer.timeout.connect(func():
		on_cooldown = false
	)
	timer.wait_time = 0.2

func _on_new_pizza() -> void:
	add_job(0, null)
	orders += 1

func _on_new_agent():
	var agg : Agent = agent_scene.instantiate()
	
	agg.path = idle_path
	agg.kitchen = self
	# TODO: Is this the best way?
	agg.break_location = break_point.position
	
	add_child(agg)
	
	agents_list.add_agent(agg)
	
	agg.delivered.connect(func reduce():
		orders-=1
	)

func add_job(id: int, location=null):
	var j := [id, location]
	
	jobs_list.add_job(j)
	jobs.append(j)
	#print(\"Added job %s at %s\" % j)
	
func request_job(curriculum):
	if on_cooldown:
		#print(\"Job assignment on cooldown\")
		return [-1, null]
		
	var idx := -1
	var id_to_group := {
		0: &\"Tables\",
		2: &\"Ovens\"
	}
	
	for i in len(jobs):
		var job := jobs[i]
		var id : int = job[0]
		
		if not curriculum[id]:
			continue
		
		if not (id in id_to_group.keys()):
			idx = i
			break
		
		var group : StringName = id_to_group[id]
		
		if get_children().any(func (k): return k.is_in_group(group) and not k.occupied):
			idx = i
			break
	
	if idx == -1:
		#print(\"No valid job found for curriculum: %s\" % [curriculum])
		return [-1, null]
		
	var output := jobs[idx]
	
	jobs.remove_at(idx)
	jobs_list.remove_job(idx)
	
	on_cooldown = true
	timer.start()
	
	#print(\"Returned job %s\" % [output])

	return output
"

[sub_resource type="Curve2D" id="Curve2D_obaid"]
_data = {
"points": PackedVector2Array(0, 0, 0, 0, 384, 192, 0, 0, 0, 0, 768, 192, 0, 0, 0, 0, 832, 320, 0, 0, 0, 0, 768, 448, 0, 0, 0, 0, 384, 448, 0, 0, 0, 0, 320, 320, 0, 0, 0, 0, 384, 192)
}
point_count = 7

[sub_resource type="StyleBoxFlat" id="StyleBoxFlat_qkld0"]
bg_color = Color(0.133333, 0.141176, 0.152941, 1)

[sub_resource type="GDScript" id="GDScript_ckxp2"]
resource_name = "ui"
script/source = "extends Control

@onready var order_count: Label = $VBoxContainer2/OrderCount
@onready var pizza_list: HBoxContainer = $VBoxContainer2/PizzaList
@onready var score_label: Label = $Score

func _on_kitchen_orders_changed(new_val: int, diff: int) -> void:
	order_count.text = \"Total orders: %d\" % new_val
	
	if diff > 0:
		pizza_list.add_pizza()
	else:
		pizza_list.remove_first()
"

[sub_resource type="GDScript" id="GDScript_rxako"]
resource_name = "orders_view"
script/source = "extends HBoxContainer

@export var pizza_scene : PackedScene = preload(\"res://Scenes/Pizza.tscn\")
@export var UI: Panel

var offset := -1.0
var times := []

func add_pizza():
	var pizza = pizza_scene.instantiate()
	times.append(Time.get_unix_time_from_system())
	add_child(pizza)

func remove_first():
	remove_child(get_child(0))
	var score = 100 - (Time.get_unix_time_from_system() - times.pop_front())
	UI.score_label.score += score
	
"

[sub_resource type="StyleBoxFlat" id="StyleBoxFlat_qvvrj"]
content_margin_left = 10.0
content_margin_top = 10.0
content_margin_right = 10.0
content_margin_bottom = 10.0
bg_color = Color(0.133333, 0.141176, 0.152941, 1)

[sub_resource type="GDScript" id="GDScript_yxx6q"]
resource_name = "jobs"
script/source = "extends ScrollContainer

@onready var container: VBoxContainer = $VBoxContainer

func add_job(job: Array):
	var lbl := Label.new()
	var place_name : String = job[1].name if job[1] != null else \"null\"
	
	lbl.text = \"%d @ %s\" % [job[0], place_name]
	
	container.add_child(lbl)
	
func remove_job(idx: int):
	var to_remove = container.get_child(idx)
	
	to_remove.queue_free()
"

[sub_resource type="GDScript" id="GDScript_jx185"]
resource_name = "agents_list"
script/source = "extends ScrollContainer

@onready var container = $VBoxContainer

var template : Control

func _ready():
	template = container.get_child(0)
	container.remove_child(template)
	
func add_agent(a: Agent):
	var tmp := template.duplicate()
	
	container.add_child(tmp)
	tmp.setup(a.agent_id, a.possible_actions)
"

[sub_resource type="StyleBoxFlat" id="StyleBoxFlat_37v5x"]
content_margin_left = 5.0
content_margin_top = 5.0
content_margin_right = 5.0
content_margin_bottom = 5.0
bg_color = Color(0.0214346, 0.0214346, 0.0214346, 1)
corner_radius_top_left = 6
corner_radius_top_right = 6
corner_radius_bottom_right = 6
corner_radius_bottom_left = 6

[sub_resource type="GDScript" id="GDScript_subwx"]
resource_name = "agent_list_element_template"
script/source = "extends PanelContainer

@onready var name_lbl = $VBoxContainer/Name
@onready var actions_lbl = $VBoxContainer/Actions

func setup(n, a):
	var jobs_str = []
	if a[0]:
		jobs_str.append(\"Impastatore\")
	if a[1]:
		jobs_str.append(\"Decoratore\")
	if a[2]:
		jobs_str.append(\"Pizzaiolo\")
	if a[3]:
		jobs_str.append(\"Cameriere\")
	
	name_lbl.text = \"%s\" % n
	actions_lbl.text = \", \\n\".join(jobs_str)
"

[node name="Kitchen" type="Node2D"]
script = SubResource("GDScript_i6dm0")

[node name="IdlePath" type="Path2D" parent="."]
position = Vector2(128, 0)
curve = SubResource("Curve2D_obaid")

[node name="Oven" parent="." instance=ExtResource("1_nda1u")]
position = Vector2(192, 584)

[node name="Oven2" parent="." instance=ExtResource("1_nda1u")]
position = Vector2(320, 584)

[node name="Oven3" parent="." instance=ExtResource("1_nda1u")]
position = Vector2(1088, 584)

[node name="Oven4" parent="." instance=ExtResource("1_nda1u")]
position = Vector2(1216, 584)

[node name="Table" parent="." instance=ExtResource("2_5wjk2")]
position = Vector2(640, 320)

[node name="Table2" parent="." instance=ExtResource("2_5wjk2")]
position = Vector2(768, 320)

[node name="Table3" parent="." instance=ExtResource("2_5wjk2")]
position = Vector2(640, 584)

[node name="Table4" parent="." instance=ExtResource("2_5wjk2")]
position = Vector2(768, 584)

[node name="Fridge" type="Sprite2D" parent="." groups=["Fridges"]]
position = Vector2(1216, 128)
scale = Vector2(1.6, 3.2)
texture = ExtResource("3_nlnuv")

[node name="DoughFridge" type="Sprite2D" parent="." groups=["Fridges"]]
position = Vector2(192, 128)
scale = Vector2(1.6, 3.2)
texture = ExtResource("3_nlnuv")

[node name="Exit" type="Sprite2D" parent="." groups=["Exit"]]
position = Vector2(704, 16)
scale = Vector2(3.2, 0.4)
texture = ExtResource("4_bx3c8")

[node name="BreakPoint" type="Sprite2D" parent="." groups=["Break"]]
modulate = Color(1, 1, 1, 0.270588)
position = Vector2(1154, 385)
texture = ExtResource("5_kmdbf")

[node name="BreakLabel" type="Label" parent="BreakPoint"]
offset_left = -70.0
offset_top = -106.0
offset_right = 66.0
offset_bottom = -71.0
theme_override_colors/font_color = Color(1, 1, 1, 1)
theme_override_colors/font_shadow_color = Color(0, 0.501961, 1, 1)
theme_override_font_sizes/font_size = 25
text = "Break Time"
metadata/_edit_use_anchors_ = true

[node name="CanvasLayer" type="CanvasLayer" parent="."]
layer = 5

[node name="UI" type="Panel" parent="CanvasLayer"]
offset_left = 128.0
offset_top = 648.0
offset_right = 1280.0
offset_bottom = 768.0
theme_override_styles/panel = SubResource("StyleBoxFlat_qkld0")
script = SubResource("GDScript_ckxp2")

[node name="VBoxContainer2" type="VBoxContainer" parent="CanvasLayer/UI"]
layout_mode = 1
anchors_preset = 9
anchor_bottom = 1.0
offset_left = 8.0
offset_top = 8.0
offset_right = 909.0
offset_bottom = -8.0
grow_vertical = 2
alignment = 1

[node name="OrderCount" type="Label" parent="CanvasLayer/UI/VBoxContainer2"]
layout_mode = 2
size_flags_vertical = 0
theme_override_colors/font_color = Color(1, 1, 1, 1)
theme_override_colors/font_shadow_color = Color(0.792157, 0.176471, 0, 1)
theme_override_font_sizes/font_size = 24
text = "Total orders: 0"

[node name="PizzaList" type="HBoxContainer" parent="CanvasLayer/UI/VBoxContainer2" node_paths=PackedStringArray("UI")]
layout_mode = 2
size_flags_horizontal = 0
size_flags_vertical = 3
alignment = 1
script = SubResource("GDScript_rxako")
UI = NodePath("../..")

[node name="VBoxContainer" type="VBoxContainer" parent="CanvasLayer/UI"]
layout_mode = 1
anchors_preset = 11
anchor_left = 1.0
anchor_right = 1.0
anchor_bottom = 1.0
offset_left = -160.0
offset_right = -15.0
grow_horizontal = 0
grow_vertical = 2
alignment = 1

[node name="NewPizza" type="Button" parent="CanvasLayer/UI/VBoxContainer"]
layout_mode = 2
size_flags_vertical = 6
theme_override_font_sizes/font_size = 28
text = "New pizza"

[node name="AddAgent" type="Button" parent="CanvasLayer/UI/VBoxContainer"]
layout_mode = 2
size_flags_vertical = 6
theme_override_font_sizes/font_size = 28
text = "Add agent"

[node name="Score" type="Label" parent="CanvasLayer/UI"]
layout_mode = 0
offset_left = 326.0
offset_top = 5.0
offset_right = 826.0
offset_bottom = 40.0
theme_override_colors/font_color = Color(1, 1, 1, 1)
theme_override_colors/font_shadow_color = Color(0, 0.501961, 1, 1)
theme_override_font_sizes/font_size = 25
text = "Score: 0"
horizontal_alignment = 1
script = ExtResource("6_8jt66")

[node name="JobsList" type="ScrollContainer" parent="CanvasLayer"]
unique_name_in_owner = true
offset_left = 1280.0
offset_right = 1408.0
offset_bottom = 768.0
theme_override_styles/panel = SubResource("StyleBoxFlat_qvvrj")
script = SubResource("GDScript_yxx6q")

[node name="VBoxContainer" type="VBoxContainer" parent="CanvasLayer/JobsList"]
layout_mode = 2
size_flags_horizontal = 3

[node name="AgentsList" type="ScrollContainer" parent="CanvasLayer"]
unique_name_in_owner = true
offset_right = 128.0
offset_bottom = 768.0
theme_override_styles/panel = SubResource("StyleBoxFlat_qvvrj")
horizontal_scroll_mode = 3
script = SubResource("GDScript_jx185")

[node name="VBoxContainer" type="VBoxContainer" parent="CanvasLayer/AgentsList"]
layout_mode = 2
size_flags_horizontal = 3
size_flags_vertical = 3

[node name="Template" type="PanelContainer" parent="CanvasLayer/AgentsList/VBoxContainer"]
layout_mode = 2
theme_override_styles/panel = SubResource("StyleBoxFlat_37v5x")
script = SubResource("GDScript_subwx")

[node name="VBoxContainer" type="VBoxContainer" parent="CanvasLayer/AgentsList/VBoxContainer/Template"]
layout_mode = 2

[node name="Name" type="Label" parent="CanvasLayer/AgentsList/VBoxContainer/Template/VBoxContainer"]
layout_mode = 2
text = "Name"

[node name="Actions" type="Label" parent="CanvasLayer/AgentsList/VBoxContainer/Template/VBoxContainer"]
layout_mode = 2
text = "[0,1]"

[connection signal="orders_changed" from="." to="CanvasLayer/UI" method="_on_kitchen_orders_changed"]
[connection signal="pressed" from="CanvasLayer/UI/VBoxContainer/NewPizza" to="." method="_on_new_pizza"]
[connection signal="pressed" from="CanvasLayer/UI/VBoxContainer/AddAgent" to="." method="_on_new_agent"]
